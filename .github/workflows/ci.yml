name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [22.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure Git line endings
      if: runner.os == 'Windows'
      run: |
        git config --global core.autocrlf false
        git config --global core.eol lf

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Run type checking
      run: npx tsc --noEmit

    - name: Run unit tests
      run: npm test -- --passWithNoTests
      if: always()

  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build extension
      run: npm run compile

    - name: Package extension
      run: npx vsce package --allow-missing-repository

    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: docx-markdown-converter-vsix
        path: '*.vsix'

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=critical || true
      # Note: Some vulnerabilities in transitive deps (npm, semantic-release) cannot be auto-fixed

  release:
    name: Release Extension
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download VSIX artifact
      uses: actions/download-artifact@v4
      with:
        name: docx-markdown-converter-vsix

    - name: Configure Git for version bumping
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

    - name: Auto version bump (patch)
      if: "contains(github.event.head_commit.message, '[version:patch]')"
      run: |
        npm run version:patch
        NEW_VERSION=$(node -p "require('./package.json').version")
        git add package.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git tag "v${NEW_VERSION}"
        git push origin main --tags

    - name: Auto version bump (minor)  
      if: "contains(github.event.head_commit.message, '[version:minor]')"
      run: |
        npm run version:minor
        NEW_VERSION=$(node -p "require('./package.json').version")
        git add package.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git tag "v${NEW_VERSION}"
        git push origin main --tags

    - name: Auto version bump (major)
      if: "contains(github.event.head_commit.message, '[version:major]')"
      run: |
        npm run version:major
        NEW_VERSION=$(node -p "require('./package.json').version")
        git add package.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git tag "v${NEW_VERSION}"
        git push origin main --tags

    - name: Semantic Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
          npm run release
        fi

    - name: Manual Deploy (if VSCE_PAT available)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        if [ -n "$VSCE_PAT" ]; then
          npm run deploy
        else
          echo "Skipping VS Code Marketplace publish - VSCE_PAT not configured"
        fi
