name: Regression Tests

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]

jobs:
  regression-tests:
    name: Run Regression Test Suite
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint code
        run: npm run lint
        continue-on-error: false
      
      - name: Run unit tests
        run: npm run test:unit || true
      
      - name: Run functional tests
        run: npm run test:functional || true
      
      - name: Run regression analysis
        run: npm run test:regression || true
      
      - name: Upload regression reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-reports-node-${{ matrix.node-version }}
          path: test/reports/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const reportDir = 'test/reports';
            if (!fs.existsSync(reportDir)) {
              console.log('No regression reports found');
              return;
            }
            
            const files = fs.readdirSync(reportDir).filter(f => f.endsWith('.json'));
            if (files.length === 0) {
              console.log('No regression report files found');
              return;
            }
            
            const latestReport = files.sort().pop();
            if (!latestReport) {
              console.log('No report to comment on');
              return;
            }
            
            const report = JSON.parse(fs.readFileSync(path.join(reportDir, latestReport), 'utf-8'));
            
            let comment = `## Regression Test Results (Node ${{ matrix.node-version }})\n\n`;
            comment += `**Status**: ${report.summary}\n\n`;
            comment += `### Metrics\n`;
            comment += `| Metric | Before | After | Change |\n`;
            comment += `|--------|--------|-------|--------|\n`;
            comment += `| Conversions | ${report.before.successfulConversions} | ${report.after.successfulConversions} | ${report.after.successfulConversions >= report.before.successfulConversions ? '‚úÖ' : '‚ùå'} |\n`;
            comment += `| Failures | ${report.before.failedConversions} | ${report.after.failedConversions} | ${report.after.failedConversions <= report.before.failedConversions ? '‚úÖ' : '‚ùå'} |\n`;
            comment += `| Headings | ${report.before.totalHeadings} | ${report.after.totalHeadings} | ${report.after.totalHeadings >= report.before.totalHeadings ? '‚úÖ' : '‚ùå'} |\n`;
            comment += `| Tables | ${report.before.totalTables} | ${report.after.totalTables} | ${report.after.totalTables >= report.before.totalTables ? '‚úÖ' : '‚ùå'} |\n`;
            comment += `| Issues | ${report.before.issues.length} | ${report.after.issues.length} | ${report.after.issues.length <= report.before.issues.length ? '‚úÖ' : '‚ùå'} |\n\n`;
            
            if (report.regressions && report.regressions.length > 0) {
              comment += `### üî¥ Regressions Detected\n`;
              report.regressions.forEach(r => {
                comment += `- ${r}\n`;
              });
              comment += '\n';
            }
            
            if (report.improvements && report.improvements.length > 0) {
              comment += `### üü¢ Improvements\n`;
              report.improvements.forEach(i => {
                comment += `- ${i}\n`;
              });
              comment += '\n';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  comprehensive-tests:
    name: Run Comprehensive Test Suite
    runs-on: ubuntu-latest
    needs: regression-tests
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run all tests with coverage
        run: npm run test:coverage || npm test
      
      - name: Upload coverage reports
        if: always()
        continue-on-error: true
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
