# Data Model: Golden Test Suite & Deterministic Output

**Feature**: `005-golden-test-determinism`
**Date**: 2026-02-10

## Entities

### Fixture

A synthetic test input paired with its expected output. Declared in `fixtures.json`.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | ✅ | Unique identifier, e.g., `tables-nested` |
| `type` | `"docx"` \| `"clipboard"` | ✅ | Input source type |
| `input` | string | ✅ | Relative path to input file (e.g., `inputs/tables-nested.docx`) |
| `expected` | string | ✅ | Relative path to expected Markdown (e.g., `expected/tables-nested.md`) |
| `imagesManifest` | string \| null | ❌ | Path to images-manifest.json, or null if fixture has no images |
| `invariants` | string[] | ✅ | List of invariant rule IDs to check (at least 2 per fixture) |
| `description` | string | ❌ | Human-readable description of what the fixture tests |

**Relationships**: One Fixture → one Golden Snapshot, zero or one Image Manifest.

**Validation rules**:
- `id` must be unique across all fixtures.
- `input` path must resolve to an existing file.
- `expected` path must resolve to an existing file (or be created by `test:golden:update`).
- `invariants` array must contain at least 2 entries.
- `type` must be one of the two allowed values.

---

### Golden Snapshot

A checked-in expected Markdown output file for a fixture.

| Field | Type | Description |
|-------|------|-------------|
| Path | string | File path under `test/golden/fixtures/expected/`, e.g., `expected/tables-nested.md` |
| Content | string (UTF-8) | Normalized Markdown: LF line endings, no trailing whitespace, max 2 consecutive blank lines, trimmed edges, trailing newline |

**Validation rules**:
- File must be UTF-8 encoded.
- Line endings must be LF (enforced by `.gitattributes`).
- Content must pass all invariants declared for its fixture.

**State transitions**:
- **Created**: Generated by first `test:golden:update` run.
- **Verified**: Matches actual conversion output in `npm test`.
- **Stale**: Actual output differs (test fails with unified diff).
- **Updated**: Regenerated by `test:golden:update` after intentional change.

---

### Image Manifest

A JSON file listing expected images for a fixture.

| Field | Type | Description |
|-------|------|-------------|
| Path | string | File path, e.g., `expected/images-spaces-unicode.images-manifest.json` |
| Entries | ImageManifestEntry[] | Array of expected image records |

#### ImageManifestEntry

| Field | Type | Description |
|-------|------|-------------|
| `filename` | string | Expected image filename, e.g., `image-001.png` |
| `sha256` | string | Hex-encoded SHA-256 hash of the image content |
| `byteLength` | number | Size of the image in bytes |

**Validation rules**:
- Entries are sorted by `filename` for deterministic comparison.
- Comparison is order-independent (both sides sorted before deep-equal).
- `sha256` must be a 64-character lowercase hex string.
- `byteLength` must be a positive integer.

---

### Invariant

A semantic boolean check applied to conversion output.

| Field | Type | Description |
|-------|------|-------------|
| `rule` | string | Unique rule identifier, e.g., `no-script-tags` |
| `pattern` | RegExp \| function | Detection logic |
| `message` | string | Human-readable failure description |

#### Defined Invariants

| Rule ID | Description | Detection |
|---------|-------------|-----------|
| `no-script-tags` | No `<script>` tags in output | `/<\/?script[\s>]/i` |
| `no-javascript-uri` | No `javascript:` links | `/javascript\s*:/i` |
| `no-inline-style` | No `style=` attributes | `/style\s*=\s*["']/i` |
| `no-mso-artifacts` | No Mso/Office namespace artifacts | `/\bMso\w\|mso-[\w-]+\|<o:p[\s>]\|xmlns:o\s*=/i` |
| `no-empty-image-src` | No empty image links | `/!\[[^\]]*\]\(\s*\)/` |
| `gfm-table-pipe-consistency` | All table rows have matching pipe counts | State-machine parser |
| `stable-anchors` | Anchor IDs are deterministic | Function identity test |

**Relationships**: Fixtures reference invariants by `rule` ID in their `invariants` array.

---

### InvariantViolation

Returned by invariant checks when a violation is detected.

| Field | Type | Description |
|-------|------|-------------|
| `rule` | string | The invariant rule ID that was violated |
| `message` | string | Human-readable description |
| `line` | number \| undefined | 1-indexed line number of the first offending match |
| `match` | string \| undefined | The offending substring (truncated to 100 chars) |

---

### DeterminismHook

A test-only injection point for reproducible output.

| Field | Type | Description |
|-------|------|-------------|
| `docName` | string \| undefined | Fixed document name (overrides runtime resolution) |
| `imageNamingStrategy` | function \| undefined | Fixed image naming function |
| `outputBasePath` | string \| undefined | Fixed output directory |
| `timestamp` | string \| undefined | Fixed timestamp for paste filename generation |

**Validation rules**:
- The `DeterminismHook` type definition lives in `src/types/index.ts` so the conversion pipeline can accept it as an optional parameter.
- Hook **construction and injection** happen only in `test/` code — production callers never pass a hook.
- Hooks must not affect normal extension behavior when not injected (all fields are optional; `undefined` ≡ production behavior).
- The conversion pipeline must accept optional hook parameters that default to production behavior.

---

### ConversionOptions (extended)

New optional fields added to the existing `ConversionOptions` interface (FR-031).

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `markdownFlavor` | `"gfm"` \| `"commonmark"` \| `"default"` | `"default"` | Markdown output flavor. `default` is an alias for `gfm`. |
| `lineWrapWidth` | number \| `"none"` | `"none"` | Line wrap width. `"none"` disables wrapping. |
| `headingStrategy` | `"infer"` \| `"preserve"` | `"infer"` | Whether to infer heading levels from outline numbering or preserve original. |
| `imagePathBase` | string \| undefined | undefined | Base path for image references. Default uses relative paths. |

---

## Entity Relationship Diagram

```
fixtures.json
  └─ Fixture[]
       ├─ input → DOCX or HTML file (test/golden/fixtures/inputs/)
       ├─ expected → Golden Snapshot (.md file in test/golden/fixtures/expected/)
       ├─ imagesManifest → Image Manifest (.json in test/golden/fixtures/expected/)
       │     └─ ImageManifestEntry[]
       └─ invariants[] → Invariant rule IDs
                           └─ checkInvariants() → InvariantViolation[]

ConversionOptions (extended)
  └─ New fields: markdownFlavor, lineWrapWidth, headingStrategy, imagePathBase

DeterminismHook
  └─ Injected into conversion pipeline during tests only
```
